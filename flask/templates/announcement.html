{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Announcements</h2>

    <!-- Option Selector -->
    <div class="mb-3">
        <label class="form-label fw-bold">Select Announcement Type:</label>
        <select id="announcementType" class="form-select">
            <option value="excel">Upload Excel</option>
            <option value="batch">Choose Batch</option>
        </select>
    </div>

    <!-- Excel Upload Section -->
    <div id="excelSection" class="mb-4">
        <input type="file" id="excelFile" accept=".xlsx,.xls" class="form-control mb-3">

        <!-- Table -->
        <table id="announcementTable" class="table table-bordered table-striped mt-3">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>Phone Number</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody>
                <!-- Populated via JS -->
            </tbody>
        </table>
    </div>

    <!-- Batch Selection Section (Initially Hidden) -->
    <div id="batchSection" class="mb-4" style="display:none;">
        <label class="form-label">Select Batch:</label>
        <select id="batchSelect" class="form-select">
            <option value="">-- Select Batch --</option>
            {% for batch in batches %}
            <option value="{{ batch.name }}">{{ batch.name }}</option>
            {% endfor %}
        </select>
        <p id="batchCount" class="text-muted mt-2" style="display:none;"></p>
    </div>

    <!-- Send Announcement Button -->
    <button class="btn btn-custom mt-3" id="sendAnnouncement">Send Announcement</button>
</div>

<!-- Modal for Message -->
<div class="modal fade" id="messageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Send Announcement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea id="announcementMessage" class="form-control" rows="4" placeholder="Enter your message..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-custom" id="confirmSend">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- SheetJS for Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
    let excelData = [];
    let selectedBatch = "";

    // Switch Between Excel & Batch
    document.getElementById("announcementType").addEventListener("change", function() {
        if (this.value === "excel") {
            document.getElementById("excelSection").style.display = "block";
            document.getElementById("batchSection").style.display = "none";
        } else {
            document.getElementById("excelSection").style.display = "none";
            document.getElementById("batchSection").style.display = "block";
        }
    });

    // Excel Reading
    document.getElementById("excelFile").addEventListener("change", function(e) {
        let file = e.target.files[0];
        let reader = new FileReader();
        reader.onload = function(e) {
            let data = new Uint8Array(e.target.result);
            let workbook = XLSX.read(data, {type: 'array'});
            let sheet = workbook.Sheets[workbook.SheetNames[0]];
            excelData = XLSX.utils.sheet_to_json(sheet, {header:1});
            
            let tbody = document.querySelector("#announcementTable tbody");
            tbody.innerHTML = "";
            excelData.slice(1).forEach(row => {
                if(row[0] && row[1]) {
                    let tr = `
                        <tr>
                            <td><input type="checkbox" class="row-check" checked></td>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                        </tr>
                    `;
                    tbody.innerHTML += tr;
                }
            });
        };
        reader.readAsArrayBuffer(file);
    });

    // Select All Checkbox
    document.getElementById("selectAll").addEventListener("change", function() {
        let checked = this.checked;
        document.querySelectorAll(".row-check").forEach(cb => cb.checked = checked);
    });

    // Batch Selection → Fetch Count
    document.getElementById("batchSelect").addEventListener("change", function() {
        selectedBatch = this.value;
        if(selectedBatch) {
            fetch(`/api/students/count/${selectedBatch}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("batchCount").style.display = "block";
                document.getElementById("batchCount").innerText = 
                    `Total: ${data.total} | Paid: ${data.paid} | Unpaid: ${data.unpaid}`;
            });
        } else {
            document.getElementById("batchCount").style.display = "none";
        }
    });

    // Send Button → Open Modal
    document.getElementById("sendAnnouncement").addEventListener("click", function() {
        let type = document.getElementById("announcementType").value;
        if (type === "excel") {
            if(getSelectedRows().length === 0) {
                alert("Please select at least one student.");
                return;
            }
        } else if (type === "batch") {
            if(!selectedBatch) {
                alert("Please select a batch first.");
                return;
            }
        }
        let modal = new bootstrap.Modal(document.getElementById("messageModal"));
        modal.show();
    });

    // Confirm Send → Call Backend
    document.getElementById("confirmSend").addEventListener("click", function() {
        let message = document.getElementById("announcementMessage").value.trim();
        if(message === "") {
            alert("Message cannot be empty.");
            return;
        }

        let type = document.getElementById("announcementType").value;
        let payload = { message: message };

        if (type === "excel") {
            payload.data = getSelectedRows();
        } else {
            payload.batch = selectedBatch;
        }

        fetch("{{ url_for('routes.send_announcement') }}", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        }).then(res => res.json())
          .then(resp => {
              alert("Messages sent successfully!");
              location.reload();
          }).catch(err => alert("Error sending messages: " + err));
    });

    // Helper: Get Selected Rows
    function getSelectedRows() {
        let rows = [];
        document.querySelectorAll("#announcementTable tbody tr").forEach((tr, i) => {
            let cb = tr.querySelector(".row-check");
            if(cb.checked) {
                let phone = tr.cells[1].innerText;
                let name = tr.cells[2].innerText;
                rows.push({phone: phone, name: name});
            }
        });
        return rows;
    }
</script>
{% endblock %}
