{% extends "base.html" %}

{% block content %}
<style>
/* General page style */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
}

/* Page heading */
h1 {
    color: #333;
    font-weight: 700;
}

/* Buttons */
button.btn-primary {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    border: none;
    transition: all 0.3s ease;
}
button.btn-primary:hover {
    background: linear-gradient(135deg, #2575fc, #6a11cb);
    transform: translateY(-2px);
}
/* Style for DataTables length dropdown */
.dataTables_length label {
    font-weight: 500;
    color: #444;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
}

.dataTables_length select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fff;
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.student-search-container {
    position: relative;
}

.student-search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
}

.student-search-input:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
}

.student-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    border-top: none;
    border-radius: 0 0 6px 6px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.student-dropdown-item {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
}

.student-dropdown-item:hover {
    background-color: #f8f9fa;
}

.student-dropdown-item:last-child {
    border-bottom: none;
}

.student-dropdown-item.selected {
    background-color: #e3f2fd;
}

.student-name {
    font-weight: 500;
    color: #333;
}

.student-phone {
    font-size: 12px;
    color: #666;
    margin-left: 5px;
}

.dataTables_length select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
}

/* Table styling */
.table {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.table th {
    background: #2575fc;
    color: #fff;
    font-weight: 600;
    text-align: center;
}
.table td {
    vertical-align: middle;
    text-align: center;
    padding: 10px;
}
.table-striped tbody tr:nth-of-type(odd) {
    background-color: #f9fbfd;
}
.table-hover tbody tr:hover {
    background-color: #eef5ff;
}

/* Scroll wrapper */
.table-responsive {
    max-height: 400px;   /* Adjust scroll height */
    overflow-y: auto;
    border-radius: 12px;
    border: 1px solid #ddd;
    margin-bottom: 20px;
}

/* DataTables custom styling */
.dataTables_wrapper .dataTables_length label {
    font-weight: 600;
    margin-right: 10px;
}
.dataTables_wrapper .dataTables_length select {
    border-radius: 8px;
    padding: 5px 10px;
    border: 1px solid #ccc;
    margin: 0 5px;
}
.dataTables_wrapper .dataTables_filter input {
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 5px 10px;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    border-radius: 6px;
    border: 1px solid #ddd;
    padding: 4px 10px;
    margin: 2px;
    background: #fff;
    transition: all 0.2s ease;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: #2575fc;
    color: #fff !important;
    border: 1px solid #2575fc;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #6a11cb;
    color: #fff !important;
    border: 1px solid #6a11cb;
}
</style>

<div class="container mt-4">
    <h1 class="mb-4">Payments</h1>

    <!-- Add Payment Button -->
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
        Add Payment
    </button>

    <!-- Upload via Excel Button -->
    <button class="btn btn-success mb-3 ms-2" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
        Upload via Excel
    </button>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="monthFilter" class="form-select">
                <option value="">Filter by Month</option>
                <option>January</option>
                <option>February</option>
                <option>March</option>
                <option>April</option>
                <option>May</option>
                <option>June</option>
                <option>July</option>
                <option>August</option>
                <option>September</option>
                <option>October</option>
                <option>November</option>
                <option>December</option>
            </select>
        </div>
        <div class="col-md-3">
            <select id="batchFilter" class="form-select">
                <option value="">Filter by Batch</option>
                {% for batch in batches %}
                <option value="{{ batch.name }}">{{ batch.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Payments Table -->
    <div class="table-responsive">
        <table id="paymentsTable" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Phone</th>
                    <th>Batch</th>
                    <th>Month</th>
                    <th>Year</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td>{{ payment.students.name }}</td>
                    <td>{{ payment.students.phone }}</td>
                    <td>{{ payment.students.course }}</td>
                    <td>{{ payment.month }}</td>
                    <td>{{ payment.year }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if payment.status == 'paid' else 'danger' }}">
                            {{ payment.status|title }}
                        </span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary"
                                data-bs-toggle="modal" data-bs-target="#changeStatusModal{{ payment.id }}">
                            Change Status
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add Payment Modal -->
<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('routes.add_payment') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="batch" class="form-label">Select Batch</label>
            <select class="form-select" id="batch" name="batch" required>
                <option value="">Select Batch</option>
                {% for batch in batches %}
                <option value="{{ batch.name }}">{{ batch.name }}</option>
                {% endfor %}
            </select>
            <div class="form-text">First select the batch, then search for students</div>
          </div>
          
          <div class="mb-3">
            <label for="student_search" class="form-label">Student</label>
            <div class="student-search-container">
              <input type="text" 
                     class="form-control student-search-input" 
                     id="student_search" 
                     placeholder="Select batch first, then search by name or phone number..."
                     autocomplete="off"
                     disabled>
              <div class="student-dropdown" id="studentDropdown">
                <!-- Dropdown items will be populated by JavaScript -->
              </div>
              <input type="hidden" id="student_id" name="student_id" required>
            </div>
            <div id="studentSearchHelp" class="form-text" style="color: #6c757d;">
              Please select a batch first to enable student search
            </div>
          </div>
          
          <div class="mb-3">
            <label for="month" class="form-label">Month</label>
            <select class="form-select" id="month" name="month" required>
                <option value="">Select Month</option>
                <option>January</option>
                <option>February</option>
                <option>March</option>
                <option>April</option>
                <option>May</option>
                <option>June</option>
                <option>July</option>
                <option>August</option>
                <option>September</option>
                <option>October</option>
                <option>November</option>
                <option>December</option>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="year" class="form-label">Year</label>
            <input type="number" class="form-control" id="year" name="year" value="{{ current_year }}" required>
          </div>
          
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status" required>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload via Excel Modal -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadExcelModalLabel">Upload Payments via Excel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('routes.upload_payments_excel') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label for="batch" class="form-label">Select Batch</label>
            <select class="form-select" id="batch" name="batch" required>
                <option value="">Select Batch</option>
                {% for batch in batches %}
                <option value="{{ batch.name }}">{{ batch.name }}</option>
                {% endfor %}
            </select>
            <div class="form-text">Select the batch for which you're uploading payments</div>
          </div>
          <div class="mb-3">
            <label for="excel_file" class="form-label">Select Excel File</label>
            <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls,.csv" required>
            <div class="form-text">
                File should have columns: Student Name, Student Number/Phone, and months (January, February, etc.)<br>
                Mark cells as "paid" for paid months, leave empty or any other value for unpaid.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% for payment in payments %}
<div class="modal fade" id="changeStatusModal{{ payment.id }}" tabindex="-1" aria-labelledby="changeStatusModalLabel{{ payment.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Status for {{ payment.students.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('routes.update_payment_status', payment_id=payment.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="new_status{{ payment.id }}" class="form-label">Select New Status</label>
            <select class="form-select" id="new_status{{ payment.id }}" name="status" required>
              <option value="paid" {% if payment.status == 'paid' %}selected{% endif %}>Paid</option>
              <option value="unpaid" {% if payment.status == 'unpaid' %}selected{% endif %}>Unpaid</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Status</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<!-- Scripts -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script type="application/json" id="students-data">
{{ students|tojson }}
</script>

<script type="application/json" id="batches-data">
{{ batches|tojson }}
</script>

<script>
$(document).ready(function () {
    var studentsData = JSON.parse(document.getElementById('students-data').textContent);
    var batchesData = JSON.parse(document.getElementById('batches-data').textContent);

    var table = $('#paymentsTable').DataTable({
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50],
        ordering: true,
        searching: true,
        scrollY: "400px",
        scrollCollapse: true,
        language: {
            search: "Search:"
        }
    });

    // Month filter dropdown
    $('#monthFilter').on('change', function () {
        var month = $(this).val();
        if (month) {
            table.column(3).search('^' + month + '$', true, false).draw(); // Column 3 is month
        } else {
            table.column(3).search('').draw();
        }
    });

    // Batch filter dropdown
    $('#batchFilter').on('change', function () {
        var batch = $(this).val();
        if (batch) {
            table.column(2).search('^' + batch + '$', true, false).draw(); // Column 2 is batch
        } else {
            table.column(2).search('').draw();
        }
    });

    // Add Payment Modal functionality
    var $batchSelect = $('#batch');
    var $searchInput = $('#student_search');
    var $dropdown = $('#studentDropdown');
    var $hiddenInput = $('#student_id');
    var $searchHelp = $('#studentSearchHelp');
    var selectedIndex = -1;
    var currentBatch = '';

    // Enable/disable student search based on batch selection
    $batchSelect.on('change', function() {
        currentBatch = $(this).val();
        if (currentBatch) {
            $searchInput.prop('disabled', false);
            $searchInput.attr('placeholder', 'Search by name or phone number...');
            $searchHelp.html('Search for students in batch: <strong>' + currentBatch + '</strong>');
            $searchHelp.css('color', '#198754'); // Green color when enabled
        } else {
            $searchInput.prop('disabled', true);
            $searchInput.attr('placeholder', 'Select batch first, then search by name or phone number...');
            $searchInput.val('');
            $hiddenInput.val('');
            $searchHelp.html('Please select a batch first to enable student search');
            $searchHelp.css('color', '#6c757d'); // Gray color when disabled
            $dropdown.hide();
        }
    });

    // Function to filter and display students for the selected batch
    function filterStudents(query) {
        if (!query || !currentBatch) {
            $dropdown.hide();
            return;
        }

        // Filter students by batch AND search query
        var filtered = studentsData.filter(function(student) {
            var matchesBatch = student.course === currentBatch;
            var matchesQuery = student.name.toLowerCase().indexOf(query.toLowerCase()) !== -1 ||
                              student.phone.indexOf(query) !== -1;
            return matchesBatch && matchesQuery;
        });

        if (filtered.length > 0) {
            var html = '';
            for (var i = 0; i < filtered.length; i++) {
                var student = filtered[i];
                html += '<div class="student-dropdown-item" data-id="' + student.id + '" data-index="' + i + '">';
                html += '<span class="student-name">' + escapeHtml(student.name) + '</span>';
                html += '<span class="student-phone">(' + escapeHtml(student.phone) + ')</span>';
                html += '</div>';
            }
            $dropdown.html(html).show();
            selectedIndex = -1;
        } else {
            $dropdown.hide();
            // Show no results message
            if (query.length > 0) {
                $dropdown.html('<div class="student-dropdown-item text-muted">No students found in batch "' + currentBatch + '" matching "' + query + '"</div>').show();
            }
        }
    }

    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Handle input typing
    $searchInput.on('input', function() {
        var query = $(this).val().trim();
        filterStudents(query);
        $hiddenInput.val(''); // Clear hidden input when typing
    });

    // Handle dropdown item click
    $(document).on('click', '.student-dropdown-item', function() {
        if ($(this).hasClass('text-muted')) return; // Ignore no results message
        
        var studentId = $(this).data('id');
        var studentName = $(this).find('.student-name').text();
        var studentPhone = $(this).find('.student-phone').text();
        
        $searchInput.val(studentName + ' ' + studentPhone);
        $hiddenInput.val(studentId);
        $dropdown.hide();
        $searchHelp.html('Selected: <strong>' + studentName + '</strong> from batch: <strong>' + currentBatch + '</strong>');
        $searchHelp.css('color', '#0d6efd'); // Blue color when selected
    });

    // Handle keyboard navigation
    $searchInput.on('keydown', function(e) {
        if (!currentBatch) return;
        
        var $items = $dropdown.find('.student-dropdown-item').not('.text-muted');
        
        if (e.keyCode === 40) { // ArrowDown
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, $items.length - 1);
            updateSelection($items);
        } else if (e.keyCode === 38) { // ArrowUp
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection($items);
        } else if (e.keyCode === 13) { // Enter
            e.preventDefault();
            if (selectedIndex >= 0) {
                $items.eq(selectedIndex).click();
            }
        } else if (e.keyCode === 27) { // Escape
            $dropdown.hide();
            selectedIndex = -1;
        }
    });

    function updateSelection($items) {
        $items.removeClass('selected');
        if (selectedIndex >= 0) {
            $items.eq(selectedIndex).addClass('selected');
            // Scroll to selected item
            $items.eq(selectedIndex)[0].scrollIntoView({block: 'nearest'});
        }
    }

    // Hide dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.student-search-container').length) {
            $dropdown.hide();
            selectedIndex = -1;
        }
    });

    // Clear form when modal is closed
    $('#addPaymentModal').on('hidden.bs.modal', function() {
        $batchSelect.val('');
        $searchInput.val('').prop('disabled', true);
        $hiddenInput.val('');
        $dropdown.hide();
        $searchHelp.html('Please select a batch first to enable student search');
        $searchHelp.css('color', '#6c757d');
        selectedIndex = -1;
        currentBatch = '';
        
        // Reset other form fields
        $('#month').val('');
        $('#year').val('{{ current_year }}');
        $('#status').val('paid');
    });

    // Form validation before submission
    $('form').on('submit', function(e) {
        if (!$hiddenInput.val()) {
            e.preventDefault();
            alert('Please select a student from the dropdown');
            return false;
        }
        if (!$batchSelect.val()) {
            e.preventDefault();
            alert('Please select a batch');
            return false;
        }
    });
});
</script>

{% endblock %}