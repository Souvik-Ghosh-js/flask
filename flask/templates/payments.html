{% extends "base.html" %}

{% block content %}
<style>
/* General page style */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
}

/* Page heading */
h1 {
    color: #333;
    font-weight: 700;
}

/* Buttons */
button.btn-primary {
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    border: none;
    transition: all 0.3s ease;
}
button.btn-primary:hover {
    background: linear-gradient(135deg, #2575fc, #6a11cb);
    transform: translateY(-2px);
}
/* Style for DataTables length dropdown */
.dataTables_length label {
    font-weight: 500;
    color: #444;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
}

.dataTables_length select {
    padding: 6px 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    background: #fff;
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.dataTables_length select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 4px rgba(0, 123, 255, 0.3);
}

/* Table styling */
.table {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}
.table th {
    background: #2575fc;
    color: #fff;
    font-weight: 600;
    text-align: center;
}
.table td {
    vertical-align: middle;
    text-align: center;
    padding: 10px;
}
.table-striped tbody tr:nth-of-type(odd) {
    background-color: #f9fbfd;
}
.table-hover tbody tr:hover {
    background-color: #eef5ff;
}

/* Scroll wrapper */
.table-responsive {
    max-height: 400px;   /* Adjust scroll height */
    overflow-y: auto;
    border-radius: 12px;
    border: 1px solid #ddd;
    margin-bottom: 20px;
}

/* DataTables custom styling */
.dataTables_wrapper .dataTables_length label {
    font-weight: 600;
    margin-right: 10px;
}
.dataTables_wrapper .dataTables_length select {
    border-radius: 8px;
    padding: 5px 10px;
    border: 1px solid #ccc;
    margin: 0 5px;
}
.dataTables_wrapper .dataTables_filter input {
    border-radius: 8px;
    border: 1px solid #ccc;
    padding: 5px 10px;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    border-radius: 6px;
    border: 1px solid #ddd;
    padding: 4px 10px;
    margin: 2px;
    background: #fff;
    transition: all 0.2s ease;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: #2575fc;
    color: #fff !important;
    border: 1px solid #2575fc;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #6a11cb;
    color: #fff !important;
    border: 1px solid #6a11cb;
}
</style>

<div class="container mt-4">
    <h1 class="mb-4">Payments</h1>

    <!-- Add Payment Button -->
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
        Add Payment
    </button>

    <!-- Upload via Excel Button -->
<button class="btn btn-success mb-3 ms-2" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
    Upload via Excel
</button>

    <!-- Filters -->
    <div class="row mb-3">
        <div class="col-md-3">
            <select id="monthFilter" class="form-select">
                <option value="">Filter by Month</option>
                <option>January</option>
                <option>February</option>
                <option>March</option>
                <option>April</option>
                <option>May</option>
                <option>June</option>
                <option>July</option>
                <option>August</option>
                <option>September</option>
                <option>October</option>
                <option>November</option>
                <option>December</option>
            </select>
        </div>
    </div>

    <!-- Payments Table -->
    <div class="table-responsive">
        <table id="paymentsTable" class="table table-bordered table-striped table-hover">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Month</th>
                    <th>Year</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payment in payments %}
                <tr>
                    <td>{{ payment.students.name }}</td>
                    <td>{{ payment.month }}</td>
                    <td>{{ payment.year }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if payment.status == 'paid' else 'danger' }}">
                            {{ payment.status|title }}
                        </span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-primary"
                                data-bs-toggle="modal" data-bs-target="#changeStatusModal{{ payment.id }}">
                            Change Status
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload Payments via Excel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('routes.upload_payments_excel') }}" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label for="excel_file" class="form-label">Select Excel File</label>
            <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
          </div>
          <p>Excel format: <strong>Student Name | Month | Status</strong></p>
          <p>Year will be auto-filled: Months before Jan → 2024, Jan and later → 2025</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Upload</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Payment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('routes.add_payment') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="student_id" class="form-label">Student</label>
            <select class="form-select" id="student_id" name="student_id" required>
              {% for student in students %}
              <option value="{{ student.id }}">{{ student.name }} ({{ student.phone }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="month" class="form-label">Month</label>
            <select class="form-select" id="month" name="month" required>
                <option value="">Select Month</option>
                <option>January</option>
                <option>February</option>
                <option>March</option>
                <option>April</option>
                <option>May</option>
                <option>June</option>
                <option>July</option>
                <option>August</option>
                <option>September</option>
                <option>October</option>
                <option>November</option>
                <option>December</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="year" class="form-label">Year</label>
            <input type="number" class="form-control" id="year" name="year" required>
          </div>
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status" required>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Change Status Modals -->
{% for payment in payments %}
<div class="modal fade" id="changeStatusModal{{ payment.id }}" tabindex="-1" aria-labelledby="changeStatusModalLabel{{ payment.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Status for {{ payment.students.name }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('routes.update_payment_status', payment_id=payment.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="new_status{{ payment.id }}" class="form-label">Select New Status</label>
            <select class="form-select" id="new_status{{ payment.id }}" name="status" required>
              <option value="paid" {% if payment.status == 'paid' %}selected{% endif %}>Paid</option>
              <option value="unpaid" {% if payment.status == 'unpaid' %}selected{% endif %}>Unpaid</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Status</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}

<!-- DataTables Scripts -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>

<script>
$(document).ready(function () {
    var table = $('#paymentsTable').DataTable({
        pageLength: 5,
        lengthMenu: [5, 10, 25, 50],
        ordering: true,
        searching: true,
        scrollY: "300px",
        scrollCollapse: true,
        language: {
            search: "Search:"
        }
    });

    // Month filter dropdown
    $('#monthFilter').on('change', function () {
        var month = $(this).val();
        if (month) {
            table.column(1).search('^' + month + '$', true, false).draw();
        } else {
            table.column(1).search('').draw();
        }
    });
});
</script>
{% endblock %}
