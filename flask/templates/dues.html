{% extends "base.html" %}

{% block content %}
<style>
    .navbar {
        background: linear-gradient(90deg, #4e54c8, #8f94fb);
    }

    .navbar-brand,
    .nav-link {
        color: #fff !important;
        font-weight: 500;
    }

    .nav-link:hover {
        color: #ffd700 !important;
    }

    .card {
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .card-title {
        font-weight: 600;
    }

    .alert-primary {
        background-color: #4e54c8;
        color: white;
    }

    .alert-success {
        background-color: #28a745;
        color: white;
    }

    .alert-danger {
        background-color: #dc3545;
        color: white;
    }

    .alert-warning {
        background-color: #ffc107;
        color: #212529;
    }

    table.dataTable tbody tr:hover {
        background-color: #f0f4ff;
    }

    .btn-custom {
        background: linear-gradient(90deg, #4e54c8, #8f94fb);
        color: white;
        border: none;
    }

    .btn-custom:hover {
        background: linear-gradient(90deg, #8f94fb, #4e54c8);
        color: white;
    }

    .due-row {
        background-color: #ffe6e6 !important;
    }
</style>
</head>

<body>


    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="card p-4 mb-4">
            <h3 class="card-title mb-4">Dues Management</h3>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="batchFilter" class="form-label">Select Batch</label>
                    <select class="form-select" id="batchFilter">
                        <option value="">All Batches</option>
                        {% for batch in batches %}
                        <option value="{{ batch.name }}">{{ batch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="monthFilter" class="form-label">Select Month</label>
                    <select class="form-select" id="monthFilter">
                        <option value="">Latest Month</option>
                        {% for month in ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August',
                        'September', 'October', 'November', 'December'] %}
                        <option value="{{ month }}">{{ month }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 align-self-end">
                    <button class="btn btn-custom mt-3" onclick="sendReminders()">Send Reminders</button>
                    <button class="btn btn-custom mt-3" onclick="exportDues()">Export Dues</button>
                </div>
            </div>

            <table id="duesTable" class="table table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th>Student Name</th>
                        <th>Phone</th>
                        <th>Batch</th>
                        <th>Dues</th>
                        <th style="display:none;">DuesCount</th> <!-- Hidden column -->
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    {% set dues = [] %}
                    {% for payment in payments if payment.student_id == student.id and payment.status == 'unpaid' %}
                    {% set _ = dues.append(payment.month ~ ' ' ~ payment.year) %}
                    {% endfor %}
                    <tr class="{% if dues|length > 1 %}table-danger{% endif %}">
                        <td>{{ student.name }}</td>
                        <td>{{ student.phone }}</td>
                        <td>{{ student.course }}</td>
                        <td>
                            {{ dues|join(', ') or 'None' }}
                        </td>
                        <td style="display:none;">{{ dues|length }}</td> <!-- hidden column for sorting -->
                        <td>
                            <button class="btn btn-sm btn-custom"
                                onclick="sendReminder('{{ student.phone }}', '{{ student.name }}')">
                                Send Reminder
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>



            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script>
        $(document).ready(function () {
            const table = $('#duesTable').DataTable({
                order: [[4, 'desc']],  // sort by dues count
                columnDefs: [
                    { targets: 4, visible: false },
                    { orderable: false, targets: 5 }
                ],
            });

            $('#batchFilter').on('change', function () {
                table.column(2).search($(this).val()).draw();
            });

            $('#monthFilter').on('change', function () {
                table.column(3).search($(this).val(), true, false).draw();
            });
        });





        function sendReminder(phone, name) {
            const message = `Reminder: Dear ${name}, you have pending dues. Please make the payment at your earliest convenience.`;
            $.ajax({
                url: '{{ url_for("routes.send_announcement") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    data: [{ phone: phone }],
                    message: message
                }),
                success: function (response) {
                    alert('Reminder sent successfully!');
                },
                error: function () {
                    alert('Error sending reminder.');
                }
            });
        }

        function sendReminders() {
            const batch = $('#batchFilter').val();
            const month = $('#monthFilter').val();
            const message = `Reminder: You have pending dues for ${month || 'the latest month'}. Please make the payment at your earliest convenience.`;
            const students = [];

            $('#duesTable tbody tr').each(function () {
                const rowBatch = $(this).find('td:eq(2)').text();
                const dues = $(this).find('td:eq(3)').text();
                if ((batch === '' || rowBatch === batch) && (month === '' || dues.includes(month))) {
                    students.push({
                        phone: $(this).find('td:eq(1)').text()
                    });
                }
            });

            $.ajax({
                url: '{{ url_for("routes.send_reminders_batch") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    data: students,
                    batch: batch,
                    message: message
                }),
                success: function (response) {
                    alert('Reminders sent successfully!');
                },
                error: function () {
                    alert('Error sending reminders.');
                }
            });
        }

        function exportDues() {
            const batch = $('#batchFilter').val();
            const month = $('#monthFilter').val();
            window.location.href = '{{ url_for("routes.export_dues") }}?batch=' + encodeURIComponent(batch) + '&month=' + encodeURIComponent(month);
        }
    </script>
    {% endblock %}